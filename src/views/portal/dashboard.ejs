<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Portal do Cliente</title>
    <link rel="icon" type="image/webp" href="/public/favicon.webp" />
    <link rel="stylesheet" href="/public/portal.css" />
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>
<body>
    <div class="app-layout">
        <%- include('../partials/portal-sidebar', { active: 'dashboard' }) %>
        <%- include('../partials/portal-topbar', { breadcrumb: 'Portal / Dashboard' }) %>

        <main class="content">
            <div class="card" style="background-color: transparent; border: none; padding: 0;">
                <div style="margin-bottom: 24px;">
                    <h1>Bem-vindo(a), <%= user.name.split(' ')[0] %>!</h1>
                    <p style="color: var(--text-secondary); margin-top: 4px;">Aqui está um resumo do seu projeto.</p>
                </div>
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <p class="label">Chamados Ativos</p>
                        <p class="value"><%= stats.openTickets %></p>
                    </div>
                    <div class="dashboard-card">
                        <p class="label">Chamados Concluídos</p>
                        <p class="value"><%= stats.closedTickets %></p>
                    </div>
                    <% if (locals.supportHoursLimit && locals.supportHoursLimit > 0) { %>
                    <div class="dashboard-card" id="chart-card">
                        <div id="hours-chart" style="width: 100%; height: 250px;"></div>
                    </div>
                    <% } %>
                </div>
            </div>
        </main>
        <div class="mobile-overlay" id="mobile-overlay"></div>
    </div>
    
    <%- include('../partials/portal-scripts') %>

    <script type="text/javascript">
      const supportHoursLimit = parseFloat("<%= locals.supportHoursLimit || 0 %>");
      if (supportHoursLimit > 0) {
          google.charts.load("current", { packages: ["corechart"] });
          google.charts.setOnLoadCallback(drawChart);
      }

      function drawChart() {
          const usedHours = parseFloat("<%= locals.usedSupportHours || 0 %>");
          const remainingHours = supportHoursLimit > usedHours ? supportHoursLimit - usedHours : 0;
          const isDarkMode = document.body.classList.contains("dark-mode");

          const data = google.visualization.arrayToDataTable([
              ["Horas", "Quantidade"],
              ["Utilizadas", usedHours],
              ["Restantes", remainingHours],
          ]);

          const options = {
              title: "Consumo de Horas de Suporte", pieHole: 0.5, colors: ["#1187bd", "#e0e0e0"],
              legend: "none", backgroundColor: "transparent", chartArea: { width: "90%", height: "80%" },
              titleTextStyle: { color: isDarkMode ? "#e9ecef" : "#495057", fontSize: 16 },
              pieSliceTextStyle: { color: "#ffffff", fontSize: 14, fontWeight: "bold" },
              tooltip: { textStyle: { color: "#0c0d0f" } },
          };

          if (isDarkMode) {
              options.colors = ["#1187bd", "#343a40"];
          }

          const chart = new google.visualization.PieChart(document.getElementById("hours-chart"));
          chart.draw(data, options);
      }
    </script>
</body>
</html>